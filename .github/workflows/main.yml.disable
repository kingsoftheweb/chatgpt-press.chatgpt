name: Deploy

on:
  push:
    branches:
      - master
      - deploy

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Configure SSH
        run: |
            mkdir -p ~/.ssh/
            echo "$SSH_KEY" >> ~/.ssh/id_rsa
            chmod 600 ~/.ssh/id_rsa
            echo 'content of id_rsa is : '
            cat ~/.ssh/id_rsa

            cat >>~/.ssh/config <<END
            Host dev
              HostName $SSH_HOST
              User $SSH_USERNAME
              IdentityFile ~/.ssh/id_rsa
              StrictHostKeyChecking no
            END

      - name: Run deploy script
        run: |
          ssh dev '
              cd $SSH_DIR
              find . ! -name "uploads" -a ! -name "wp-config.php" -delete || echo 'couldnt delete everything'
            '
          scp ./"$archive"/archive.tar.gz dev:"$SSH_DIR"

      - name: Extract
        run: |
          ssh dev '
            cd files
            tar -xzf archive.tar.gz
            cp -r $THEME/* ./
            rm -rf $THEME
            rm -rf archive.tar.gz
          '


env:
  ACCESS_TOKEN: ${{ secrets.ACCESS_TOKEN }}
  SSH_DIR: ${{ secrets.SSH_DIR }}
  SSH_HOST: ${{ secrets.SSH_HOST }}
  SSH_KEY: ${{ secrets.SSH_KEY }}
  SSH_USERNAME: ${{ secrets.SSH_USERNAME }}
  THEME: kotw-base-theme
